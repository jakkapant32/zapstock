// backend/src/routes/products.js
const express = require('express');
const db = require('../db'); // ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏°‡∏î‡∏π‡∏• db ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
const router = express.Router();

// Middleware ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô Admin (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡πÜ)
// ‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ JWT token verification
const isAdmin = (req, res, next) => {
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ
  // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡πÄ‡∏ä‡πà‡∏ô:
  // if (req.user && req.user.role === 'admin') {
  //   next();
  // } else {
  //   res.status(403).json({ message: 'Forbidden: Admin access required' });
  // }
  next(); // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
};


/**
 * @route GET /api/products
 * @description ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
 * @access Public
 */
router.get('/', async (req, res) => {
  try {
    const result = await db.query(`
      SELECT
        p.id,
        p.name,
        p.description,
        p.sku,
        p.barcode,
        p.current_stock as "currentStock",
        p.min_stock_quantity as "minStockQuantity",
        p.max_stock_quantity as "maxStockQuantity",
        p.price,
        p.cost_price as "costPrice",
        p.weight,
        p.dimensions,
        p.image_url as "image",
        p.status,
        p.category_id as "categoryId",
        p.supplier_id as "supplierId",
        p.created_by as "createdBy",
        c.name as "categoryName",
        p.created_at as "createdAt",
        p.updated_at as "updatedAt"
      FROM products p
      LEFT JOIN categories c ON p.category_id = c.id
      ORDER BY p.name ASC
    `);
    res.json(result.rows);
  } catch (err) {
    console.error('Error fetching products:', err.message);
    res.status(500).json({ message: 'Server error', error: err.message });
  }
});

/**
 * @route GET /api/products/:id
 * @description ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏° ID ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
 * @access Public
 */
router.get('/:id', async (req, res) => {
  const { id } = req.params;
  try {
    const result = await db.query(`
      SELECT
        p.id,
        p.name,
        p.description,
        p.sku,
        p.barcode,
        p.current_stock as "currentStock",
        p.min_stock_quantity as "minStockQuantity",
        p.max_stock_quantity as "maxStockQuantity",
        p.price,
        p.cost_price as "costPrice",
        p.weight,
        p.dimensions,
        p.image_url as "image",
        p.status,
        p.category_id as "categoryId",
        p.supplier_id as "supplierId",
        p.created_by as "createdBy",
        c.name as "categoryName",
        p.created_at as "createdAt",
        p.updated_at as "updatedAt"
      FROM products p
      LEFT JOIN categories c ON p.category_id = c.id
      WHERE p.id = $1
    `, [id]);
    if (result.rows.length === 0) {
      return res.status(404).json({ message: 'Product not found' });
    }
    res.json(result.rows[0]);
  } catch (err) {
    console.error('Error fetching product by ID:', err.message);
    res.status(500).json({ message: 'Server error', error: err.message });
  }
});

/**
 * @route POST /api/products
 * @description ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
 * @access Admin (‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
 */
router.post('/', isAdmin, async (req, res) => {
  const { 
    name, description, sku, barcode, currentStock, minStockQuantity, maxStockQuantity, 
    price, costPrice, weight, dimensions, image, status, categoryId, supplierId 
  } = req.body;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° logging ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
  console.log('üìù Creating product with data:', {
    name, description, sku, barcode, currentStock, minStockQuantity, maxStockQuantity,
    price, costPrice, weight, dimensions, image, status, categoryId, supplierId
  });

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏õ‡∏•‡∏á base64 ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ñ‡πâ‡∏≤‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  let imageUrl = image;
  if (image && image.startsWith('data:image/')) {
    console.log('üñºÔ∏è  ‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö base64 image, ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô URL ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
    // ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á cloud storage
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å base64 ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
    imageUrl = image;
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
  if (!name || currentStock === undefined || minStockQuantity === undefined || price === undefined) {
    return res.status(400).json({ message: 'Name, currentStock, minStockQuantity, and price are required' });
  }

  try {
    const result = await db.query(
      `INSERT INTO products (
        name, description, sku, barcode, current_stock, min_stock_quantity, max_stock_quantity,
        price, cost_price, weight, dimensions, image_url, status, category_id, supplier_id,
        created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, NOW(), NOW())
       RETURNING id, name, description, sku, barcode, current_stock as "currentStock", 
       min_stock_quantity as "minStockQuantity", max_stock_quantity as "maxStockQuantity",
       price, cost_price as "costPrice", weight, dimensions, image_url as "image", status,
       category_id as "categoryId", supplier_id as "supplierId", created_at as "createdAt", updated_at as "updatedAt"`,
      [name, description, sku || null, barcode || null, currentStock, minStockQuantity, 
       maxStockQuantity || null, price, costPrice || null, weight || null, dimensions || null,
       imageUrl || null, status || 'active', categoryId || null, supplierId || null]
    );

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ categoryId ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á categoryName ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    let newProduct = result.rows[0];
    if (categoryId) {
      const categoryResult = await db.query('SELECT name FROM categories WHERE id = $1', [categoryId]);
      if (categoryResult.rows.length > 0) {
        newProduct.categoryName = categoryResult.rows[0].name;
      }
    }

    res.status(201).json(newProduct);
  } catch (err) {
    console.error('Error adding product:', err.message);
    res.status(500).json({ message: 'Server error', error: err.message });
  }
});

/**
 * @route PUT /api/products/:id
 * @description ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 * @access Admin (‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
 */
router.put('/:id', isAdmin, async (req, res) => {
  const { id } = req.params;
  const { 
    name, description, sku, barcode, currentStock, minStockQuantity, maxStockQuantity,
    price, costPrice, weight, dimensions, image, status, categoryId, supplierId 
  } = req.body;
  
  console.log('üîÑ Updating product:', { 
    id, name, description, sku, barcode, currentStock, minStockQuantity, maxStockQuantity,
    price, costPrice, weight, dimensions, image, status, categoryId, supplierId 
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á array ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö fields ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡∏∞ values
  const updates = [];
  const values = [id]; // ‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏Å‡∏Ñ‡∏∑‡∏≠ id ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö WHERE clause
  let paramIndex = 2; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà $2 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó

  if (name !== undefined) {
    updates.push(`name = $${paramIndex++}`);
    values.push(name);
  }
  if (description !== undefined) {
    updates.push(`description = $${paramIndex++}`);
    values.push(description);
  }
  if (sku !== undefined) {
    updates.push(`sku = $${paramIndex++}`);
    values.push(sku);
  }
  if (currentStock !== undefined) {
    updates.push(`current_stock = $${paramIndex++}`);
    values.push(currentStock);
  }
  if (minStockQuantity !== undefined) {
    updates.push(`min_stock_quantity = $${paramIndex++}`);
    values.push(minStockQuantity);
  }
  if (price !== undefined) {
    updates.push(`price = $${paramIndex++}`);
    values.push(price);
  }
  if (barcode !== undefined) {
    updates.push(`barcode = $${paramIndex++}`);
    values.push(barcode);
  }
  if (maxStockQuantity !== undefined) {
    updates.push(`max_stock_quantity = $${paramIndex++}`);
    values.push(maxStockQuantity);
  }
  if (costPrice !== undefined) {
    updates.push(`cost_price = $${paramIndex++}`);
    values.push(costPrice);
  }
  if (weight !== undefined) {
    updates.push(`weight = $${paramIndex++}`);
    values.push(weight);
  }
  if (dimensions !== undefined) {
    updates.push(`dimensions = $${paramIndex++}`);
    values.push(dimensions);
  }
  if (image !== undefined) {
    updates.push(`image_url = $${paramIndex++}`);
    values.push(image);
    console.log('  ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏° image ‡πÉ‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:', image);
  }
  if (status !== undefined) {
    updates.push(`status = $${paramIndex++}`);
    values.push(status);
  }
  if (categoryId !== undefined) { // categoryId ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô null ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
    updates.push(`category_id = $${paramIndex++}`);
    values.push(categoryId);
  }
  if (supplierId !== undefined) {
    updates.push(`supplier_id = $${paramIndex++}`);
    values.push(supplierId);
  }

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° updated_at
  updates.push(`updated_at = CURRENT_TIMESTAMP`);

  if (updates.length === 0) {
    return res.status(400).json({ message: 'No fields to update' });
  }

  try {
    console.log('üìù SQL Query:', `UPDATE products SET ${updates.join(', ')} WHERE id = $1`);
    console.log('üî¢ Values:', values);
    
    const result = await db.query(
      `UPDATE products SET ${updates.join(', ')} WHERE id = $1
       RETURNING id, name, description, sku, barcode, current_stock as "currentStock", 
       min_stock_quantity as "minStockQuantity", max_stock_quantity as "maxStockQuantity",
       price, cost_price as "costPrice", weight, dimensions, image_url as "image", status,
       category_id as "categoryId", supplier_id as "supplierId", created_at as "createdAt", updated_at as "updatedAt"`,
      values
    );

    if (result.rows.length === 0) {
      return res.status(404).json({ message: 'Product not found' });
    }

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏ categoryId ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á categoryName ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢
    let updatedProduct = result.rows[0];
    if (updatedProduct.categoryId) {
      const categoryResult = await db.query('SELECT name FROM categories WHERE id = $1', [updatedProduct.categoryId]);
      if (categoryResult.rows.length > 0) {
        updatedProduct.categoryName = categoryResult.rows[0].name;
      }
    } else {
      updatedProduct.categoryName = null; // ‡∏ñ‡πâ‡∏≤ categoryId ‡πÄ‡∏õ‡πá‡∏ô null ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏°‡∏µ categoryName
    }

    res.json(updatedProduct);
  } catch (err) {
    console.error('Error updating product:', err.message);
    res.status(500).json({ message: 'Server error', error: err.message });
  }
});

/**
 * @route DELETE /api/products/:id
 * @description ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
 * @access Admin (‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
 */
router.delete('/:id', isAdmin, async (req, res) => {
  const { id } = req.params;
  try {
    const result = await db.query('DELETE FROM products WHERE id = $1 RETURNING id', [id]);
    if (result.rows.length === 0) {
      return res.status(404).json({ message: 'Product not found' });
    }
    res.json({ message: 'Product deleted successfully', id: result.rows[0].id });
  } catch (err) {
    console.error('Error deleting product:', err.message);
    res.status(500).json({ message: 'Server error', error: err.message });
  }
});

module.exports = router;
